{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h3 class="card-title mb-0">Ler QR Code</h3>
            </div>
            <div class="card-body text-center">
                <div class="alert alert-info mb-4">
                    <i class="bi bi-info-circle"></i> Posicione o QR Code dentro da área do scanner
                </div>
                
                <div class="position-relative mb-3" style="max-width: 500px; margin: 0 auto;">
                    <video id="qr-video" width="100%" playsinline style="border-radius: 8px;"></video>
                    <div class="scanner-overlay"></div>
                </div>
                
                <div id="result" class="mt-3"></div>
                
                <div class="mt-4">
                    <button id="toggle-camera" class="btn btn-outline-primary me-2">
                        <i class="bi bi-camera-reverse"></i> Trocar Câmera
                    </button>
                    <button id="stop-scanner" class="btn btn-outline-danger">
                        <i class="bi bi-stop-circle"></i> Parar Scanner
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/qr-scanner@1.4.1/qr-scanner.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const video = document.getElementById('qr-video');
    const resultContainer = document.getElementById('result');
    const toggleCameraBtn = document.getElementById('toggle-camera');
    const stopScannerBtn = document.getElementById('stop-scanner');
    
    let qrScanner = null;
    let currentCamera = 'environment'; // Começa com a câmera traseira
    
    function initScanner(camera) {
        if (qrScanner) {
            qrScanner.stop();
            qrScanner = null;
        }
        
        qrScanner = new QrScanner(
            video,
            result => handleScan(result.data),
            {
                preferredCamera: camera,
                highlightScanRegion: true,
                highlightCodeOutline: true,
            }
        );
        
        qrScanner.start();
    }
    
    function handleScan(qrData) {
        fetch("{% url 'ler_qr_code' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: `qr_data=${encodeURIComponent(qrData)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                resultContainer.innerHTML = `
                    <div class="alert alert-success">
                        <h5 class="alert-heading">Pontos adicionados!</h5>
                        <p class="mb-1">Promoção: ${data.promocao_nome}</p>
                        <p class="mb-1">Pontos: ${data.pontos}/${data.necessarios}</p>
                        <p class="mb-0">Prêmio: ${data.premio}</p>
                    </div>
                `;
                
                // Atualiza a página após 3 segundos
                setTimeout(() => {
                    window.location.href = "{% url 'home' %}";
                }, 3000);
            } else {
                resultContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <h5 class="alert-heading">Erro</h5>
                        <p>${data.error || 'QR Code inválido ou promoção não encontrada'}</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            resultContainer.innerHTML = `
                <div class="alert alert-danger">
                    <h5 class="alert-heading">Erro no servidor</h5>
                    <p>${error}</p>
                </div>
            `;
        });
    }
    
    // Iniciar scanner com a câmera padrão
    initScanner(currentCamera);
    
    // Alternar entre câmeras
    toggleCameraBtn.addEventListener('click', () => {
        currentCamera = currentCamera === 'environment' ? 'user' : 'environment';
        initScanner(currentCamera);
    });
    
    // Parar scanner
    stopScannerBtn.addEventListener('click', () => {
        if (qrScanner) {
            qrScanner.stop();
            qrScanner = null;
            video.srcObject = null;
            resultContainer.innerHTML = `
                <div class="alert alert-warning">
                    Scanner parado. Recarregue a página para reiniciar.
                </div>
            `;
        }
    });
    
    // Parar scanner quando a página for fechada
    window.addEventListener('beforeunload', () => {
        if (qrScanner) {
            qrScanner.stop();
        }
    });
});
</script>

<style>
.scanner-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    border: 2px solid rgba(0, 255, 0, 0.5);
    border-radius: 8px;
    pointer-events: none;
}
</style>
{% endblock %}