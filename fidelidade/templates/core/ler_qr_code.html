<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor de QR Code - Fidelize</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 100%;
            padding: 0;
        }
        
        header {
            text-align: center;
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .scanner-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            width: 100%;
        }
        
        #video-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            height: 60vh;
            margin: 0 auto 30px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        }
        
        #qr-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        
        #scan-region {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 70%;
            height: 70%;
            transform: translate(-50%, -50%);
            border: 3px dashed rgba(255, 255, 255, 0.7);
            border-radius: 12px;
            box-sizing: border-box;
            box-shadow: 0 0 0 100vmax rgba(0, 0, 0, 0.5);
            pointer-events: none;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
            width: 100%;
            max-width: 800px;
        }
        
        button {
            padding: 14px 28px;
            font-size: 1.1rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 180px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        #start-scan {
            background-color: #28a745;
            color: white;
        }
        
        #stop-scan {
            background-color: #dc3545;
            color: white;
        }
        
        #flash-button {
            background-color: #ffc107;
            color: #212529;
        }
        
        #back-button {
            background-color: #6c757d;
            color: white;
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            min-width: 120px;
            padding: 10px 20px;
        }
        
        #result-container {
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        #result {
            font-size: 1.3rem;
            font-weight: 600;
            min-height: 30px;
            padding: 10px;
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.2);
        }
        
        .scanning {
            color: #ffc107;
            animation: pulse 1.5s infinite;
        }
        
        .success {
            color: #28a745;
        }
        
        .error {
            color: #dc3545;
        }
        
        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }
        
        footer {
            text-align: center;
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: auto;
        }
        
        .status {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .promocao-info {
            background-color: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            text-align: left;
        }
        
        .promocao-info h3 {
            margin-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 5px;
        }
        
        .progresso {
            height: 20px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progresso-bar {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            border-radius: 10px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 1.8rem;
            }
            
            #video-container {
                height: 50vh;
            }
            
            button {
                min-width: 160px;
                padding: 12px 20px;
                font-size: 1rem;
            }
            
            #back-button {
                position: relative;
                left: auto;
                top: auto;
                transform: none;
                margin-bottom: 15px;
            }
            
            header {
                padding-top: 70px;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
        }
        
        @media (max-width: 480px) {
            h1 {
                font-size: 1.5rem;
            }
            
            #video-container {
                height: 40vh;
            }
            
            button {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <button id="back-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
                </svg>
                Voltar
            </button>
            <h1>Leitor de QR Code Fidelity</h1>
            <p class="subtitle">Posicione o código QR dentro da área destacada para registrar pontos</p>
        </header>
        
            <button onclick="reiniciarScanner()" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-arrow-repeat me-1"></i>Ler Outro QR Code
            </button>
        
        <div class="scanner-container">
            <div id="video-container">
                <video id="qr-video"></video>
                <div id="scan-region"></div>
            </div>
                      
            <div class="controls">
                <button id="start-scan">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4zm11.5 1a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-1zM5 5.5A.5.5 0 0 1 5.5 5h1a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-3z"/>
                        <path d="M0 6.5A.5.5 0 0 1 .5 6h2a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1-.5-.5v-1z"/>
                    </svg>
                    Iniciar Lei1tura
                </button>
                <button id="stop-scan">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M5 3.5h6A1.5 1.5 0 0 1 12.5 5v6a1.5 1.5 0 0 1-1.5 1.5H5A1.5 1.5 0 0 1 3.5 11V5A1.5 1.5 0 0 1 5 3.5z"/>
                    </svg>
                    Parar Leitura
                </button>
                <button id="flash-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M9.5 1.5a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-4a.5.5 0 0 1-.5-.5v-4a.5.5 0 0 1 .5-.5h4zm-1 1h-3v3h3v-3z"/>
                        <path d="M7 12.5a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-4a.5.5 0 0 1-.5-.5v-4zm1 1v3h3v-3h-3z"/>
                        <path d="M13.5 7a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-4a.5.5 0 0 1-.5-.5v-4a.5.5 0 0 1 .5-.5h4zm-1 1h-3v3h3v-3z"/>
                        <path d="M1.5 7a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-4a.5.5 0 0 1-.5-.5v-4a.5.5 0 0 1 .5-.5h4zm-1 1h-3v3h3v-3z"/>
                    </svg>
                    Ligar/Desligar Flash
                </button>
                
            </div>
             
            
            <div id="result-container">
                <p>Resultado: <span id="result" class="scanning">Lendo...</span></p>
                <div id="promocao-info" class="promocao-info" style="display: none;">
                    <!-- Aqui serão exibidas as informações da promoção -->
                </div>
            </div>
        </div>
        
        <footer>
            <p>&copy; 2025 Fidelize. Todos os direitos reservados.</p>
            <div class="status">
                <span id="camera-status">Câmera: Ativa</span>
                <span id="flash-status">Flash: Desligado</span>
            </div>
        </footer>
    </div>

    <script type="module">
        import QrScanner from "https://cdn.jsdelivr.net/npm/qr-scanner@1.4.1/qr-scanner.min.js";

        const video = document.getElementById('qr-video');
        const resultSpan = document.getElementById('result');
        const startScanBtn = document.getElementById('start-scan');
        const stopScanBtn = document.getElementById('stop-scan');
        const flashButton = document.getElementById('flash-button');
        const backButton = document.getElementById('back-button');
        const cameraStatus = document.getElementById('camera-status');
        const flashStatus = document.getElementById('flash-status');
        const promocaoInfo = document.getElementById('promocao-info');

        let qrScanner;
        let qrCodeRegistrado = false;

        // Simulação de banco de dados de promoções
        const promocoes = {
            "PROMO001": { nome: "Promoção de Verão", pontos: 10, necessarios: 50, premio: "Desconto de 20%" },
            "PROMO002": { nome: "Fidelidade Ouro", pontos: 15, necessarios: 100, premio: "Brinde Exclusivo" },
            "PROMO003": { nome: "Cliente Premium", pontos: 25, necessarios: 200, premio: "Jantar para dois" },
            "PROMO123": { nome: "Teste de Sistema", pontos: 5, necessarios: 10, premio: "Café grátis" }
        };

        // Simulação de pontos do usuário (em um sistema real, isso viria do backend)
        let pontosUsuario = {
            "PROMO001": 30,
            "PROMO002": 75,
            "PROMO003": 150,
            "PROMO123": 5
        };

        function initScanner() {
            qrScanner = new QrScanner(video, result => {
                if (qrCodeRegistrado) return; // Evita múltiplos registros
                
                const qrData = result.data;
                resultSpan.textContent = qrData;
                resultSpan.classList.remove('scanning');
                
                // Verificar se é um QR Code válido para promoção
                if (promocoes[qrData]) {
                    registrarPontos(qrData);
                } else {
                    resultSpan.textContent = "QR Code inválido";
                    resultSpan.classList.add('error');
                    setTimeout(() => {
                        resultSpan.textContent = "Lendo...";
                        resultSpan.classList.remove('error');
                        resultSpan.classList.add('scanning');
                        qrCodeRegistrado = false;
                    }, 3000);
                }
            }, {
                highlightScanRegion: true,
                highlightCodeOutline: true,
            });

            startScanBtn.addEventListener('click', () => {
                qrScanner.start().then(() => {
                    resultSpan.textContent = 'Lendo...';
                    resultSpan.classList.add('scanning');
                    resultSpan.classList.remove('success', 'error');
                    cameraStatus.textContent = 'Câmera: Ativa';
                    qrCodeRegistrado = false;
                    promocaoInfo.style.display = 'none';
                });
            });

            stopScanBtn.addEventListener('click', () => {
                qrScanner.stop();
                resultSpan.textContent = 'Leitura Parada';
                resultSpan.classList.remove('scanning', 'success', 'error');
                resultSpan.style.color = '#dc3545';
                cameraStatus.textContent = 'Câmera: Inativa';
            });

            flashButton.addEventListener('click', async () => {
                try {
                    await qrScanner.toggleFlash();
                    if (qrScanner.isFlashOn) {
                        flashButton.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M9.5 1.5a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-4a.5.5 0 0 1-.5-.5v-4a.5.5 0 0 1 .5-.5h4zm-1 1h-3v3h3v-3z"/>
                                <path d="M7 12.5a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-4a.5.5 0 0 1-.5-.5v-4zm1 1v3h3v-3h-3z"/>
                                <path d="M13.5 7a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-4a.5.5 0 0 1-.5-.5v-4a.5.5 0 0 1 .5-.5h4zm-1 1h-3v3h3v-3z"/>
                                <path d="M1.5 7a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-4a.5.5 0 0 1-.5-.5v-4a.5.5 0 0 1 .5-.5h4zm-1 1h-3v3h3v-3z"/>
                            </svg>
                            Desligar Flash
                        `;
                        flashStatus.textContent = 'Flash: Ligado';
                    } else {
                        flashButton.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M9.5 1.5a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-4a.5.5 0 0 1-.5-.5v-4a.5.5 0 0 1 .5-.5h4zm-1 1h-3v3h3v-3z"/>
                                <path d="M7 12.5a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-4a.5.5 0 0 1-.5-.5v-4zm1 1v3h3v-3h-3z"/>
                                <path d="M13.5 7a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-4a.5.5 0 0 1-.5-.5v-4a.5.5 0 0 1 .5-.5h4zm-1 1h-3v3h3v-3z"/>
                                <path d="M1.5 7a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-4a.5.5 0 0 1-.5-.5v-4a.5.5 0 0 1 .5-.5h4zm-1 1h-3v3h3v-3z"/>
                            </svg>
                            Ligar Flash
                        `;
                        flashStatus.textContent = 'Flash: Desligado';
                    }
                } catch (e) {
                    console.error("Erro ao controlar o flash:", e);
                    resultSpan.textContent = "Flash não disponível";
                    resultSpan.classList.remove('scanning');
                    resultSpan.classList.add('error');
                }
            });

            // Botão Voltar
            backButton.addEventListener('click', () => {
                if (qrScanner) {
                    qrScanner.stop();
                }
                // Redirecionar para a página anterior
                window.location.href = "{% url 'home' %}"; // Altere para a URL desejada
                // Ou usar history.back() para voltar à página anterior
                // history.back();
            });

            // Iniciar a leitura automaticamente ao carregar a página
            qrScanner.start().then(() => {
                resultSpan.textContent = 'Lendo...';
                resultSpan.classList.add('scanning');
                cameraStatus.textContent = 'Câmera: Ativa';
            });
        }

        function registrarPontos(codigoPromocao) {
            qrCodeRegistrado = true;
            
            const promocao = promocoes[codigoPromocao];
            
            // Simular requisição AJAX para o backend
            setTimeout(() => {
                // Em um sistema real, aqui seria uma chamada fetch para o backend
                // fetch('/api/registrar-pontos', { ... })
                
                // Simular resposta do servidor
                pontosUsuario[codigoPromocao] += promocao.pontos;
                const novosPontos = pontosUsuario[codigoPromocao];
                const necessarios = promocao.necessarios;
                const percentual = Math.min(100, (novosPontos / necessarios) * 100);
                
                // Exibir resultado
                resultSpan.textContent = `Pontos registrados com sucesso!`;
                resultSpan.classList.add('success');
                
                // Exibir informações da promoção
                promocaoInfo.innerHTML = `
                    <h3>${promocao.nome}</h3>
                    <p>Pontos adicionados: <strong>${promocao.pontos}</strong></p>
                    <p>Seu progresso:</p>
                    <div class="progresso">
                        <div class="progresso-bar" style="width: ${percentual}%">
                            ${novosPontos}/${necessarios} (${Math.round(percentual)}%)
                        </div>
                    </div>
                    <p>Prêmio: <strong>${promocao.premio}</strong></p>
                    ${novosPontos >= necessarios ? 
                        '<p class="success"><strong>Parabéns! Você atingiu a meta e pode resgatar seu prêmio!</strong></p>' : 
                        `<p>Faltam <strong>${necessarios - novosPontos}</strong> pontos para resgatar o prêmio</p>`
                    }
                `;
                promocaoInfo.style.display = 'block';
                
                // Prevenir nova leitura por 5 segundos
                setTimeout(() => {
                    resultSpan.textContent = "Lendo...";
                    resultSpan.classList.remove('success');
                    resultSpan.classList.add('scanning');
                    qrCodeRegistrado = false;
                }, 5000);
                
            }, 1000);
        }

        let qrCodeProcessado = false;
let tempoBloqueio = 5000; // 5 segundos

function handleScan(qrData) {
    console.log("QR Code lido:", qrData);
    
    // Prevenir múltiplas leituras
    if (qrCodeProcessado) {
        console.log("QR Code já está sendo processado...");
        return;
    }
    
    qrCodeProcessado = true;
    
    // Mostrar loading
    resultContainer.innerHTML = `
        <div class="alert alert-info">
            <h5 class="alert-heading">⏳ Processando QR Code...</h5>
            <p>Aguarde enquanto registramos seus pontos</p>
        </div>
    `;
    
    fetch("{% url 'ler_qr_code' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: `qr_data=${encodeURIComponent(qrData)}`
    })
    .then(response => {
        console.log("Status HTTP:", response.status);
        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log("Resposta do servidor:", data);
        
        if (data.success) {
            resultContainer.innerHTML = `
                <div class="alert alert-success">
                    <h5 class="alert-heading">✅ ${data.message || 'Pontos registrados!'}</h5>
                    <p class="mb-1"><strong>Promoção:</strong> ${data.promocao_nome}</p>
                    <p class="mb-1"><strong>Comércio:</strong> ${data.comercio}</p>
                    <p class="mb-1"><strong>Pontos:</strong> ${data.pontos}/${data.necessarios}</p>
                    <p class="mb-0"><strong>Prêmio:</strong> ${data.premio}</p>
                </div>
            `;
            
            // Atualizar a página após 3 segundos para ver as pontuações
            setTimeout(() => {
                window.location.reload();
            }, 3000);
            
        } else {
            resultContainer.innerHTML = `
                <div class="alert alert-danger">
                    <h5 class="alert-heading">❌ ${data.error || 'Erro'}</h5>
                    <p>Tente novamente com um QR Code válido</p>
                </div>
            `;
            
            // Liberar para nova leitura mais rápido em caso de erro
            tempoBloqueio = 2000;
        }
    })
    .catch(error => {
        console.error('Erro na requisição:', error);
        resultContainer.innerHTML = `
            <div class="alert alert-danger">
                <h5 class="alert-heading">❌ Erro de Conexão</h5>
                <p>Verifique sua conexão e tente novamente</p>
                <small>Detalhes: ${error.message}</small>
            </div>
        `;
    })
    .finally(() => {
        // Liberar para nova leitura após o tempo de bloqueio
        setTimeout(() => {
            qrCodeProcessado = false;
            resultContainer.innerHTML = `
                <div class="alert alert-info">
                    <h5 class="alert-heading">📱 Pronto para nova leitura</h5>
                    <p>Posicione outro QR Code na câmera</p>
                </div>
            `;
            console.log("Scanner liberado para nova leitura");
        }, tempoBloqueio);
    });
}

    function reiniciarScanner() {
    qrCodeProcessado = false;
    document.getElementById('reload-container').style.display = 'none';
    resultContainer.innerHTML = `
        <div class="alert alert-info">
            <i class="bi bi-qr-code me-2"></i>Pronto para nova leitura
        </div>
    `;
    
    // Reiniciar o scanner se estiver parado
    if (qrScanner) {
        qrScanner.start();
    }
}
        // Chamar initScanner quando o DOM estiver completamente carregado
        document.addEventListener('DOMContentLoaded', initScanner);
    </script>
</body>
</html>