{% extends 'base.html' %}
{% load static %}

{% block title %}Painel de Resgate - {{ comercio.nome_fantasia }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>üéÅ Painel de Resgate</h1>
        <a href="{% url 'home' %}" class="btn btn-secondary">‚Üê Voltar</a>
    </div>

    <div class="row">
        <div class="col-md-6">
            <!-- Formul√°rio de Resgate por C√≥digo -->
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">üî¢ Resgatar Pr√™mio por C√≥digo</h5>
                </div>
                <div class="card-body">
                    <form id="form-resgate">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="codigo-resgate" class="form-label">C√≥digo de Resgate (5 d√≠gitos):</label>
                            <input type="text" id="codigo-resgate" class="form-control form-control-lg text-uppercase" 
                                   maxlength="5" placeholder="Ex: A1B2C" style="font-size: 1.5rem; letter-spacing: 2px;">
                        </div>
                        <button type="submit" class="btn btn-success btn-lg w-100">
                            ‚úÖ Confirmar Resgate
                        </button>
                    </form>
                    <div id="resultado-resgate" class="mt-3"></div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <!-- Lista de Clientes com Pr√™mios Dispon√≠veis (SEM MOSTRAR O C√ìDIGO) -->
            <div class="card">
                <div class="card-header bg-warning">
                    <h5 class="mb-0">üìã Pr√™mios Aguardando Resgate</h5>
                </div>
                <div class="card-body">
                    {% if pontuacoes_resgate %}
                        <div class="list-group">
                            {% for pontuacao in pontuacoes_resgate %}
                                <div class="list-group-item">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">{{ pontuacao.cliente.usuario.get_full_name|default:pontuacao.cliente.usuario.username }}</h6>
                                        <span class="badge bg-info">Pronto para Resgate</span>
                                    </div>
                                    <p class="mb-1"><strong>{{ pontuacao.promocao.nome }}</strong></p>
                                    <small class="text-muted">Pr√™mio: {{ pontuacao.promocao.premio }}</small>
                                    <br>
                                    <small class="text-muted">
                                        ‚ö†Ô∏è Pe√ßa ao cliente o c√≥digo de 5 d√≠gitos para resgatar
                                    </small>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">Nenhum pr√™mio aguardando resgate no momento.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('form-resgate').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const codigo = document.getElementById('codigo-resgate').value.trim().toUpperCase();
        const resultado = document.getElementById('resultado-resgate');
        
        if (codigo.length !== 5) {
            resultado.innerHTML = `
                <div class="alert alert-danger">
                    ‚ùå O c√≥digo deve ter exatamente 5 caracteres
                </div>
            `;
            return;
        }
        
        // Mostrar loading
        resultado.innerHTML = `
            <div class="alert alert-info">
                ‚è≥ Processando resgate...
            </div>
        `;
        
        const formData = new FormData();
        formData.append('codigo', codigo);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        
        fetch("{% url 'resgatar_premio_comerciante' %}", {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                resultado.innerHTML = `
                    <div class="alert alert-success">
                        <h5>‚úÖ ${data.message}</h5>
                        <p><strong>C√≥digo:</strong> <span class="badge bg-primary">${data.codigo_resgate}</span></p>
                        <p><strong>Cliente:</strong> ${data.cliente}</p>
                        <p><strong>Promo√ß√£o:</strong> ${data.promocao}</p>
                        <p><strong>Pr√™mio:</strong> ${data.premio}</p>
                        <hr>
                        <p class="mb-0"><strong>üéâ Resgate confirmado com sucesso!</strong></p>
                    </div>
                `;
                document.getElementById('codigo-resgate').value = '';
                
                // Recarregar a p√°gina ap√≥s 3 segundos para atualizar a lista
                setTimeout(() => {
                    window.location.reload();
                }, 10000);
            } else {
                resultado.innerHTML = `
                    <div class="alert alert-danger">
                        ‚ùå ${data.error}
                    </div>
                `;
            }
        })
        .catch(error => {
            resultado.innerHTML = `
                <div class="alert alert-danger">
                    ‚ùå Erro de conex√£o. Tente novamente.
                </div>
            `;
        });
    });

    // Auto-uppercase e limitar a 5 caracteres
    document.getElementById('codigo-resgate').addEventListener('input', function(e) {
        this.value = this.value.toUpperCase().substring(0, 5);
    });
</script>
{% endblock %}